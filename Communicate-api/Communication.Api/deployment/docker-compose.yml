version: '3.6'
services:
  datahub-communication-api:
    image: ${DOCKER_REGISTRY_URL}/${DOCKER_IMAGE_REPO}:${DOCKER_IMAGE_TAG}
    environment:
    - ASPNETCORE_ENVIRONMENT=${ENVIRONMENT_NAME}
    - BuildVersion=${GO_PIPELINE_LABEL}
    - PROJECT_NAME=${PROJECT_NAME}
    - RABBITMQ_HOSTNAMES=${RABBITMQ_HOSTNAMES}
    - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
    - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
    - RABBITMQ_SSL_ENABLED=${RABBITMQ_SSL_ENABLED}
    - QUEUE_MANAGER_API=http://${ENVIRONMENT_NAME}-datahub-${PROJECT_NAME}-api-queuemanager.${DOMAIN_POSTFIX}/QueueManager
    - EVENT_EXCHANGE_NAME=${ENVIRONMENT_NAME}-datahub-${PROJECT_NAME}-topic-event
    - COMMAND_EXCHANGE_NAME=${ENVIRONMENT_NAME}-datahub-${PROJECT_NAME}-topic-command
    - QUEUE_NAME=${ENVIRONMENT_NAME}-datahub-${PROJECT_NAME}-queue-communication
    - FireBaseCloudMessage:BaseAppInstanceServerUrl=https://iid.googleapis.com/
    - FireBaseCloudMessage:BaseFirebaseClouldMessageUrl=https://fcm.googleapis.com/
    - FireBaseCloudMessage:FirebaseCloudMessageLegacyServerKey=${COMMUNICATION_API_FIREBASE_SERVER_KEY}
    - IDM_BASEURL=${IDM_INTERNAL_URL}
    - IDM_INTERNAL_URL=${IDM_INTERNAL_URL}
    - ORG_DOMAIN_API=http://${ENVIRONMENT_NAME}-competence-${PROJECT_NAME}-api-organization.${PROJECT_NAME}/
    - IDM_GRANT_TYPE=client_credentials
    - IDM_CLIENT_SECRET=AiOiJKV1QiLCJ4NXQiOiJhM
    - IDM_CLIENT_ID=cxDomainInternalApi
    - IDM_SCOPE=userManagement cxDomainInternalApi
    - MONGO_SSL_ENABLED=${MONGO_SSL_ENABLED}
    - MONGO_CONNECTIONSTRING=mongodb://{{ mongo_db_auth }}@${MONGODB_HOSTNAMES}/{{ mongo_db_name }} 
    - VIRTUAL_HOST=${ENVIRONMENT_NAME}-datahub-${PROJECT_NAME}-api-communication.${DOMAIN_POSTFIX}${PUBLIC_DNS}
    - Email:FromName=OPAL2.0
    - Email:FromAddress=${DISPLAY_EMAIL}
    - Email:SslEnabled=false
    - Email:MailServerAddress=${SMTP_SERVER}
    - Email:MailServerPort=${SMTP_PORT}
    - Email:UserName=${SMTP_USERNAME}
    - Email:UserPassword=${SMTP_PASSWORD}
    - Idm_ApiName=${INTERNAL_DOMAIN_API_NAME}
    - Idm_ApiSecret=${INTERNAL_DOMAIN_API_SECRET}
    - ConnectionStrings:HangfireConnection=Data Source=${MSSQL_HOSTNAMES};Initial Catalog={{HangfireDatabase}};User ID={{HangfireDatabaseUsername}};Password={{HangfireDatabasePassword}}
{% if https_proxy is defined %}
    - HTTPS_PROXY={{ https_proxy }}
{% endif %}
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "10"
    ports:
    - 0:80
networks:
  default:
    external:
      name: ${PROJECT_NAME}_default
