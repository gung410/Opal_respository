<app-toolbar [mergeHeader]="true"
             [detailToolbar]="true">
  <toolbar-left>
    <detail-title [title]="formData.title"
                  [subTitle]="formData.type"
                  [urlSubIcon]="getDetailsTitleSubIcon()"
                  [allowEditTitle]="canSaveForm || canApprove"
                  [settings]="detailTitleSettings"
                  [maxLength]="MAX_LENGTH_TITLE"
                  (titleChange)="onTitleChange($event)"
                  (onBackButtonClick)="onBackButtonClick()"></detail-title>
  </toolbar-left>
  <toolbar-right [customContainerClass]="'form-editor-page__toolbar-right-container'">
    <div class="form-editor-page__btn-container">
      <status-indicator [mapping]="statusColorMap"
                        [currentStatus]="formData.status"></status-indicator>

      <ng-container *hasPermission="[formPermission.CreateForm, !formData.isSurveyTemplate]">

        <button class="k-margin-left-10"
                *hasPermission="[formPermission.TransferOwnerShipForm, isFormOwner]"
                kendoButton
                [primary]="true"
                (click)="onTransferOwnershipBtnClicked()">{{'Transfer Ownership' | translator}}</button>

        <button class="k-margin-left-10"
                *hasPermission="[formPermission.EditForm, canShowEditButton]"
                kendoButton
                [primary]="true"
                (click)="onEditButtonClick()">{{ 'Edit' | translator }}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.EditForm, canSaveForm]"
                kendoButton
                [primary]="true"
                (click)="onSaveBtnClicked(FormStatus.Draft, true)">{{'Save' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.DuplicateForm, canSaveForm]"
                kendoButton
                [primary]="true"
                (click)="onDuplicateBtnClicked()">{{'Duplicate' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.ArchiveForm, canShowArchiveButton]"
                kendoButton
                [primary]="true"
                (click)="onArchiveBtnClicked()">{{'Archive' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.MarkAsReadyForm, canShowMarkAsReadyToUseButton]"
                kendoButton
                [primary]="true"
                (click)="onMarkAsReadyClicked()">{{'Mark as ready' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.MarkAsDraftForm, canShowMarkAsDraftButton]"
                kendoButton
                [primary]="true"
                (click)="onMarkAsDraftClicked()">{{'Mark as draft' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.SubmitForApproveForm, canSubmitForApproval]"
                kendoButton
                [primary]="true"
                (click)="onSubmitForApprovalClicked()">{{'Submit for approval' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.PublishForm, canPublish]"
                kendoButton
                [primary]="true"
                (click)="onPublishClicked()">{{'Publish' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.UnPublishForm, canUnpublish]"
                kendoButton
                [primary]="true"
                (click)="onUnpublishClicked()">{{'Unpublish' | translator}}</button>

      </ng-container>
      <ng-container *ngIf="!formData.isSurveyTemplate && isApprovingOfficer">

        <button class=" form-editor-page__save-btn"
                *hasPermission="[formPermission.ApproveForm, canApprove]"
                [primary]="true"
                kendoButton
                (click)="onApproveClicked()">{{'Approve' | translator}}</button>

        <button class="form-editor-page__save-btn"
                *hasPermission="[formPermission.RejectForm, canApprove]"
                [primary]="true"
                kendoButton
                (click)="onRejectClicked()">{{'Reject' | translator}}</button>

      </ng-container>

    </div>
  </toolbar-right>
</app-toolbar>

<div class="form-detail-page">
  <kendo-tabstrip formTabs
                  (tabSelect)="onTabSelect($event)"
                  [animate]="false"
                  *ngIf="!isWebPreview"
                  [keepTabContent]="true">
    <kendo-tabstrip-tab [selected]="true">
      <ng-template kendoTabTitle="">
        {{ 'Editor' | translator }}
      </ng-template>

      <ng-template kendoTabContent="">
        <form-editor-page *ngIf="canShowQuestionEditor"
                          [(formData)]="formData"
                          [(formSectionsQuestions)]="formSectionsQuestions"
                          (click)="!formData.isSurveyTemplate && onQuestionAreaClick()"
                          [mode]="mode">
        </form-editor-page>
        <form-assessment-rubric-management-page *ngIf="canShowAssessmentEditor"
                                                [type]="formData.type"
                                                [(assessmentData)]="formSectionsQuestions.formQuestions"
                                                [mode]="mode"></form-assessment-rubric-management-page>
      </ng-template>
    </kendo-tabstrip-tab>
    <kendo-tabstrip-tab>
      <ng-template kendoTabTitle="">
        {{ 'Additional information' | translator }}
      </ng-template>
      <ng-template kendoTabContent="">
        <detail-content-fragment class="flex detail-page f-detail-content-container"></detail-content-fragment>
        <form-additional-information-tab [formData]="formData"
                                         [resource]="resource">
        </form-additional-information-tab>
      </ng-template>
    </kendo-tabstrip-tab>
    <kendo-tabstrip-tab>
      <ng-template kendoTabTitle="">
        {{ 'Audit Log' | translator }}
      </ng-template>
      <ng-template kendoTabContent="">
        <audit-log-tab (revertChange)="onRevertData($event)"
                       [activeObjectId]="formData.id"
                       [formData]="formData"
                       [allowRevert]="(formData.status !== FormStatus.PendingApproval &&
                                       formData.status !== FormStatus.Archived) &&
                                       !formData.isSurveyTemplate"
                       [originalObjectId]="formData.originalObjectId"
                       [versionTrackingType]="versionTrackingType">
        </audit-log-tab>
      </ng-template>
    </kendo-tabstrip-tab>
    <kendo-tabstrip-tab>
      <ng-template kendoTabTitle="">
        {{ 'Access Right' | translator }}
      </ng-template>
      <ng-template kendoTabContent="">
        <access-right-tab [allowAddCollaborator]="isAllowAddCollaborator"
                          [allowDeleteCollaborator]="isOwner"
                          [originalObjectId]="formData.originalObjectId"
                          [itemTitle]="formData.title"
                          [accessRightType]="accessRightType"
                          [addSAOnly]="formData.isSurveyTemplate">
        </access-right-tab>
      </ng-template>
    </kendo-tabstrip-tab>
    <kendo-tabstrip-tab>
      <ng-template kendoTabTitle="">
        {{ 'Comments' | translator }}
      </ng-template>
      <ng-template kendoTabContent="">
        <comment-tab [input]="commentTabInput">
        </comment-tab>
      </ng-template>
    </kendo-tabstrip-tab>
    <kendo-tabstrip-tab *ngIf="canShowQuestionEditor">
      <ng-template kendoTabTitle="">
        {{ 'Report broken link' | translator }}
      </ng-template>
      <ng-template kendoTabContent="">
        <broken-link-report-tab [originalObjectId]="formData.originalObjectId"
                                [module]="brokenLinkModule"></broken-link-report-tab>
      </ng-template>
    </kendo-tabstrip-tab>
    <kendo-tabstrip-tab *ngIf="canShowQuestionEditor">
      <ng-template kendoTabTitle="">
        {{ 'Standalone' | translator }}
      </ng-template>
      <ng-template kendoTabContent="">
        <standalone-form [(formData)]="formData"
                         [formSectionsQuestions]="formSectionsQuestions"
                         [originalObjectId]="formData.originalObjectId"
                         [formParticipantType]="formParticipantType"></standalone-form>
      </ng-template>
    </kendo-tabstrip-tab>
  </kendo-tabstrip>
  <kendo-dropdownbutton *ngIf="!isWebPreview && canShowQuestionEditor"
                        [data]="previewOptions"
                        [popupSettings]="{ popupClass: 'ccpm-preview-button-modes' }"
                        [buttonClass]="'k-button-preview'">
    {{ 'Preview' | translator }}
  </kendo-dropdownbutton>

  <div class="column flex web-preview"
       *ngIf="previewMode === PreviewMode.Web || previewMode === PreviewMode.Mobile">
    <button class="k-button-close-preview"
            (click)="hideWebPreviewer()"><span class="k-icon k-i-arrow-chevron-left"></span><span>Close Preview</span></button>
    <main-quiz-player-page [formQuestionsData]="this.removeUnsupportedQuestionTypes(formSectionsQuestions.formQuestions)"
                           [isPreviewMode]="true"
                           *ngIf="previewMode === PreviewMode.Web">
    </main-quiz-player-page>
    <mobile-previewer *ngIf="previewMode === PreviewMode.Mobile">
      <ng-template mobilePreviewerContent="">
        <main-quiz-player-page class="lecture-player__quiz-player"
                               [formQuestionsData]="this.removeUnsupportedQuestionTypes(formSectionsQuestions.formQuestions)"
                               [isPreviewMode]="true"></main-quiz-player-page>
      </ng-template>
    </mobile-previewer>
  </div>
</div>


<ng-template #dialogRejectCommentTemplate="">
  <comment-dialog-template [dialogTitle]="titleRejectDialog"
                           [btnSaveText]="'Reject' | translator"
                           [requireComment]="true"
                           (onSaveClick)="saveCommentAndRejectClick($event)"
                           (onCancelClick)="onCloseDialogReject()">
  </comment-dialog-template>
</ng-template>

<ng-template #dialogApprovalCommentTemplate="">
  <comment-dialog-template [dialogTitle]="titleApprovalDialog"
                           [btnSaveText]="'Approve' | translator"
                           [requireComment]="false"
                           (onSaveClick)="saveCommentAndApproveClick($event)"
                           (onCancelClick)="onCloseDialogApprove()">
  </comment-dialog-template>
</ng-template>
